# WallStreetSim Redis Configuration
# Enables both RDB snapshots and AOF persistence for durability

################################## NETWORK #####################################

# Accept connections on all interfaces
bind 0.0.0.0

# Default port
port 6379

# TCP keepalive
tcp-keepalive 300

################################## GENERAL #####################################

# Run as a daemon (Docker handles this)
daemonize no

# Log level
loglevel notice

# Number of databases
databases 16

################################ RDB PERSISTENCE ################################
# RDB (Redis Database): Point-in-time snapshots

# Save the DB on disk:
#   after 900 sec (15 min) if at least 1 key changed
#   after 300 sec (5 min) if at least 10 keys changed
#   after 60 sec if at least 10000 keys changed
save 900 1
save 300 10
save 60 10000

# Stop accepting writes if RDB save fails
stop-writes-on-bgsave-error yes

# Compress RDB files
rdbcompression yes

# RDB checksum
rdbchecksum yes

# Sanitize RDB filenames for compatibility
sanitize-dump-payload clients

# RDB filename
dbfilename dump.rdb

# Remove RDB files used by replication in instances without persistence enabled
rdb-del-sync-files no

# Working directory for persistence files
dir /data

################################ AOF PERSISTENCE #################################
# AOF (Append Only File): Logs every write operation

# Enable AOF
appendonly yes

# AOF filename
appendfilename "appendonly.aof"

# Directory for AOF files (Redis 7+)
appenddirname "appendonlydir"

# AOF fsync policy:
#   always - fsync after every write (slowest, safest)
#   everysec - fsync once per second (good balance)
#   no - let the OS decide (fastest, least safe)
appendfsync everysec

# Don't fsync during BGSAVE or BGREWRITEAOF
no-appendfsync-on-rewrite no

# Automatic AOF rewrite thresholds
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# Load truncated AOF files
aof-load-truncated yes

# Use RDB preamble in AOF for faster loading (Redis 7+)
aof-use-rdb-preamble yes

# Timestamp annotations in AOF (Redis 7+)
aof-timestamp-enabled no

################################## MEMORY ######################################

# Max memory (adjust based on available system memory)
# maxmemory 256mb

# Eviction policy when max memory is reached
# maxmemory-policy noeviction

################################## SECURITY ####################################

# Password (set via command line or environment variable)
# requirepass is set via docker command

################################## CLIENTS #####################################

# Max simultaneous clients
maxclients 10000

################################# LAZY FREEING #################################

# Use async deletion for better performance
lazyfree-lazy-eviction no
lazyfree-lazy-expire no
lazyfree-lazy-server-del no
replica-lazy-flush no

lazyfree-lazy-user-del no
lazyfree-lazy-user-flush no

################################## SLOW LOG ####################################

# Log queries slower than 10ms
slowlog-log-slower-than 10000

# Keep 128 slow queries
slowlog-max-len 128

################################# LATENCY MONITOR ###############################

# Monitor latency for operations taking more than 0ms (disabled)
latency-monitor-threshold 0
